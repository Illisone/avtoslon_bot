<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–æ–¥–±–æ—Ä –∞–≤—Ç–æ</title>
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div class="header">
    <div class="logo-car">üèéÔ∏è</div>
    <div class="logo-text">ASIA EXPRESS AUTO</div>
</div>

<div class="container">
    
    <div class="step-indicator" id="stepIndicator">
        </div>
    
    <form id="carForm">
        <div class="card form-step" data-step="1">
            <h2>1/6. –ö–∞–∫–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?</h2>
            <div class="choice-grid" style="grid-template-columns: repeat(1, 1fr);">
                <button type="button" class="choice-button" data-value="–ù–æ–≤—ã–π">üöó –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ</button>
                <button type="button" class="choice-button" data-value="–° –ø—Ä–æ–±–µ–≥–æ–º">‚öôÔ∏è –° –ø—Ä–æ–±–µ–≥–æ–º</button>
                <button type="button" class="choice-button" data-value="–ù–µ–≤–∞–∂–Ω–æ">ü§∑‚Äç‚ôÄÔ∏è –ù–µ–≤–∞–∂–Ω–æ</button>
            </div>
            <input type="hidden" name="–¢–∏–ø –∞–≤—Ç–æ" id="carType" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button next" data-action="next">–î–ê–õ–ï–ï</button>
            </div>
        </div>

        <div class="card form-step" data-step="2" style="display:none;">
            <h2>2/6. –£–∫–∞–∂–∏—Ç–µ –º–∞—Ä–∫—É –∏ –º–æ–¥–µ–ª—å –∞–≤—Ç–æ</h2>
            <p class="label">–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å</p>
            <input type="text" name="–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å" id="carModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Toyota Camry, BYD Song Plus" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">–ù–ê–ó–ê–î</button>
                <button type="button" class="nav-button next" data-action="next">–î–ê–õ–ï–ï</button>
            </div>
        </div>

        <div class="card form-step" data-step="3" style="display:none;">
            <h2>3/6. –ñ–µ–ª–∞–µ–º—ã–π –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞</h2>
            <p class="label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2020 ‚Äî 2024)</p>
            <input type="hidden" name="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞" id="carYear" required> 
            
            <div class="choice-grid" id="yearButtons">
                </div>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">–ù–ê–ó–ê–î</button>
                <button type="button" class="nav-button next" data-action="next">–î–ê–õ–ï–ï</button>
            </div>
        </div>

        <div class="card form-step" data-step="4" style="display:none;">
            <h2>4/6. –ö–∞–∫ –í–∞—Å –∑–æ–≤—É—Ç?</h2>
            <p class="label">–í–∞—à–µ –ò–º—è</p>
            <input type="text" name="–ò–º—è" id="clientName" placeholder="–ò–≤–∞–Ω" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">–ù–ê–ó–ê–î</button>
                <button type="button" class="nav-button next" data-action="next">–î–ê–õ–ï–ï</button>
            </div>
        </div>

        <div class="card form-step" data-step="5" style="display:none;">
            <h2>5/6. –í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h2>
            <p class="label">–¢–µ–ª–µ—Ñ–æ–Ω</p>
            <input type="tel" name="–¢–µ–ª–µ—Ñ–æ–Ω" id="clientPhone" placeholder="+7 9–•–• –•–•–•-–•–•-–•–•" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">–ù–ê–ó–ê–î</button>
                <button type="button" class="nav-button next" data-action="next">–ü–†–û–í–ï–†–ò–¢–¨ –î–ê–ù–ù–´–ï</button>
            </div>
        </div>
        
        <div class="card form-step" data-step="6" style="display:none;">
            <h2>6/6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</h2>
            <div id="reviewData">
                </div>
            
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">–ù–ê–ó–ê–î</button>
                <button type="button" class="nav-button next active" id="finalSubmitButton" data-action="submit">–û–¢–ü–†–ê–í–ò–¢–¨</button>
            </div>
        </div>
        
    </form>
</div>

<script>
    // =======================================
    // JAVASCRIPT –õ–û–ì–ò–ö–ê –î–õ–Ø MINI APP
    // =======================================
    
    const Telegram = window.Telegram.WebApp;
    Telegram.ready();
    Telegram.expand(); 
    
    const formSteps = document.querySelectorAll('.form-step');
    const stepIndicator = document.getElementById('stepIndicator');
    const yearButtonsContainer = document.getElementById('yearButtons');
    const reviewDataContainer = document.getElementById('reviewData');
    const totalSteps = formSteps.length; 
    let currentStep = 1;

    let startYear = null;
    let endYear = null;

    // --- –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ì–û–î–û–í ---
    function generateYearButtons() {
        const currentYear = new Date().getFullYear();
        for (let year = currentYear + 1; year >= 2015; year--) {
            const button = document.createElement('button');
            button.type = 'button';
            button.classList.add('choice-button', 'year-range-button');
            button.dataset.value = year;
            button.textContent = year;
            yearButtonsContainer.appendChild(button);
        }
    }
    
    // ----------------------------------------
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ê–ú–ò TELEGRAM (–°–ö–†–´–í–ê–ï–ú)
    // ----------------------------------------
    if (Telegram.themeParams) {
        // –ú—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–∏ –∫–Ω–æ–ø–∫–∏, –Ω–æ –ª—É—á—à–µ –∏—Ö –≤—ã–∫–ª—é—á–∏—Ç—å
        Telegram.MainButton.hide(); 
        Telegram.BackButton.hide();
        // –£—Å—Ç–∞–Ω–æ–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ BACK BUTTON TWA, —á—Ç–æ–±—ã –æ–Ω–∞ –∑–∞–∫—Ä—ã–≤–∞–ª–∞, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫
        Telegram.BackButton.onClick(() => {
            Telegram.close();
        });
    }
    
    // ----------------------------------------
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ù–ê–í–ò–ì–ê–¶–ò–ò (–ù–ê–ó–ê–î/–î–ê–õ–ï–ï/–û–¢–ü–†–ê–í–ò–¢–¨)
    // ----------------------------------------
    
    // –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ .nav-buttons
    function handleNavigation(event) {
        const button = event.target.closest('.nav-button');
        if (!button) return;
        
        const action = button.dataset.action;

        if (action === 'back') {
            currentStep--;
            updateUI();
        } else if (action === 'next') {
            if (!button.classList.contains('active')) return; // –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

            if (checkStepValidity()) {
                currentStep++;
                updateUI();
            } else {
                Telegram.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –ø—É–Ω–∫—Ç.');
            }
        } else if (action === 'submit') {
            submitForm();
        }
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Ñ–æ—Ä–º—ã, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å –∫–ª–∏–∫–∏
    document.getElementById('carForm').addEventListener('click', handleNavigation);
    
    // ----------------------------------------
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï UI
    // ----------------------------------------

    function updateStepDots() {
        stepIndicator.innerHTML = '';
        // Dots only for the first 5 input steps
        for (let i = 1; i <= totalSteps - 1; i++) { 
            const dot = document.createElement('span');
            dot.classList.add('dot');
            if (i === currentStep) {
                dot.classList.add('active');
            }
            stepIndicator.appendChild(dot);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    function createReviewField(label, value, step) {
        const div = document.createElement('div');
        div.classList.add('review-field');
        div.innerHTML = `
            <style>
                .review-field { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
                .review-field-label { color: var(--hint-color); font-size: 0.9em; }
                .review-field-value { color: var(--text-color); font-weight: 500; display: flex; align-items: center; gap: 8px; }
                .review-field-edit { 
                    background: none; border: none; color: var(--accent-light); 
                    font-size: 1.2em; cursor: pointer; padding: 0; margin: 0; 
                    transform: translateY(2px); 
                }
            </style>
            <span class="review-field-label">${label}</span>
            <span class="review-field-value">
                ${value}
                <button class="review-field-edit" data-step="${step}" onclick="editStep(${step})">‚úèÔ∏è</button>
            </span>
        `;
        return div;
    }
    
    // –®–∞–≥ 6: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    function populateReviewData() {
        reviewDataContainer.innerHTML = '';
        const formData = {};
        document.querySelectorAll('input').forEach(input => {
            if (input.name && input.value) {
                formData[input.name] = input.value;
            }
        });

        const labelMap = {
            '–¢–∏–ø –∞–≤—Ç–æ': '–¢–∏–ø', 
            '–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å': '–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å', 
            '–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞': '–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞', 
            '–ò–º—è': '–ò–º—è', 
            '–¢–µ–ª–µ—Ñ–æ–Ω': '–¢–µ–ª–µ—Ñ–æ–Ω'
        };

        let stepForEdit = 0;
        let stepCounter = 0;
        
        for (const key in formData) {
            stepCounter++;
            const label = labelMap[key] || key;
            const value = formData[key];
            
            // –†—É—á–Ω–æ–π –º–∞–ø–ø–∏–Ω–≥ —à–∞–≥–æ–≤ –∫ –ø–æ–ª—è–º
            if (key === '–¢–∏–ø –∞–≤—Ç–æ') stepForEdit = 1;
            else if (key === '–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å') stepForEdit = 2;
            else if (key === '–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞') stepForEdit = 3;
            else if (key === '–ò–º—è') stepForEdit = 4;
            else if (key === '–¢–µ–ª–µ—Ñ–æ–Ω') stepForEdit = 5;

            if (stepForEdit > 0) {
                 reviewDataContainer.appendChild(createReviewField(label, value, stepForEdit));
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —à–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    window.editStep = function(step) {
        currentStep = step;
        updateUI();
    }


    function updateUI() {
        // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
        updateStepDots();

        // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —à–∞–≥–∏
        formSteps.forEach(step => {
            const stepIndex = parseInt(step.dataset.step);
            const isCurrent = (stepIndex === currentStep);
            step.style.display = isCurrent ? 'block' : 'none';

            if (isCurrent) {
                const nextButton = step.querySelector('.nav-button.next');
                const backButton = step.querySelector('.nav-button.back');
                
                // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é/–≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫
                
                // –ö–Ω–æ–ø–∫–∞ "–ù–ê–ó–ê–î" –≤–∏–¥–Ω–∞, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
                if (backButton) {
                    backButton.style.display = (currentStep === 1) ? 'none' : 'block';
                }
                
                // –ö–Ω–æ–ø–∫–∞ "–î–ê–õ–ï–ï"/"–û–¢–ü–†–ê–í–ò–¢–¨" –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ —à–∞–≥ –≤–∞–ª–∏–¥–µ–Ω
                if (nextButton) {
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —à–∞–≥ –ø—Ä–æ–π–¥–µ–Ω
                    if (checkStepValidity()) {
                        nextButton.classList.add('active');
                    } else {
                        nextButton.classList.remove('active');
                    }
                }
            }
        });
        
        // 4. –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤
        if (currentStep === 3) {
            visualizeYearRange();
        }
        
        if (currentStep === totalSteps) { // –®–∞–≥ 6
            populateReviewData();
        }
        
        // 5. –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
        const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        const firstInput = currentStepElement ? currentStepElement.querySelector('input:not([type="hidden"])') : null;
        if (firstInput) {
            firstInput.focus();
        }
    }
    
    // ----------------------------------------
    // –ü–†–û–í–ï–†–ö–ê –í–ê–õ–ò–î–ù–û–°–¢–ò –¢–ï–ö–£–©–ï–ì–û –®–ê–ì–ê
    // ----------------------------------------

    function checkStepValidity() {
        switch (currentStep) {
            case 1: 
                return !!document.getElementById('carType').value;
            case 2: 
                return !!document.getElementById('carModel').value.trim();
            case 3: 
                return !!document.getElementById('carYear').value.trim();
            case 4: 
                return !!document.getElementById('clientName').value.trim();
            case 5: 
                const phoneValue = document.getElementById('clientPhone').value.trim();
                return phoneValue.length > 5;
            case 6: 
                return true; 
            default:
                return false;
        }
    }
    
    // --- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –î–ò–ê–ü–ê–ó–û–ù–ê –ì–û–î–û–í ---
    function visualizeYearRange() {
        const yearInput = document.getElementById('carYear');
        const buttons = document.querySelectorAll('.year-range-button');
        
        buttons.forEach(btn => {
            btn.classList.remove('selected', 'in-range');
        });

        if (startYear && endYear) {
            const start = Math.min(startYear, endYear);
            const end = Math.max(startYear, endYear);
            yearInput.value = `${start}-${end}`;
            
            buttons.forEach(btn => {
                const year = parseInt(btn.dataset.value);
                if (year >= start && year <= end) {
                    btn.classList.add('in-range');
                }
                if (year === start || year === end) {
                    btn.classList.add('selected'); 
                    btn.classList.remove('in-range'); 
                }
            });
            updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–î–ê–õ–ï–ï"
        } else if (startYear) {
            yearInput.value = startYear;
            document.querySelector(`.year-range-button[data-value="${startYear}"]`).classList.add('selected');
            updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–î–ê–õ–ï–ï"
        } else {
            yearInput.value = '';
            updateUI(); 
        }
    }
    
    // ----------------------------------------
    // –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê (–¥–ª—è –®–∞–≥–æ–≤ 1 –∏ 3)
    // ----------------------------------------

    // –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∞–≤—Ç–æ
    document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('carType').value = this.dataset.value;
            
            updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–î–ê–õ–ï–ï"
        });
    });

    // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –î–ò–ê–ü–ê–ó–û–ù–ê –ì–û–î–û–í (–®–ê–ì 3) ---
    function handleYearSelection(event) {
        const button = event.target.closest('.year-range-button');
        if (!button) return;
        
        const year = parseInt(button.dataset.value);

        if (startYear === null) {
            startYear = year;
            endYear = null;
        } else if (endYear === null) {
            endYear = year;
        } else {
            startYear = year;
            endYear = null;
        }
        
        visualizeYearRange();
    }
    
    yearButtonsContainer.addEventListener('click', handleYearSelection);


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è –≤–≤–æ–¥–∞ (–¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ "–î–ê–õ–ï–ï")
            if (currentStep !== 3) {
                updateUI();
            }
        });
    });
    
    // ----------------------------------------
    // –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´
    // ----------------------------------------

    function submitForm() {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è
        const finalButton = document.getElementById('finalSubmitButton');
        if (finalButton.textContent === '–û–¢–ü–†–ê–í–õ–ï–ù–û') return; 
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const formData = {};
        document.querySelectorAll('input').forEach(input => {
            if (input.name && input.value) {
                formData[input.name] = input.value;
            }
        });
        
        try {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç
            Telegram.sendData(JSON.stringify(formData));
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            finalButton.textContent = '–û–¢–ü–†–ê–í–õ–ï–ù–û';
            finalButton.classList.remove('active');
            
            reviewDataContainer.innerHTML = '<h3>‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h3><p>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä. –°–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä.</p>';
            
        } catch (error) {
            Telegram.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    generateYearButtons(); 
    updateUI(); 
</script>

</body>
</html>
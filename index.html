<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–æ–¥–±–æ—Ä –∞–≤—Ç–æ</title>
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div class="header">
    <div class="logo-car">üèéÔ∏è</div>
    <div class="logo-text">ASIA EXPRESS AUTO</div>
</div>

<div class="container">
    
    <div class="step-indicator" id="stepIndicator">
        </div>
    
    <form id="carForm">
        <div class="card form-step" data-step="1">
            <h2>1/5. –ö–∞–∫–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?</h2>
            <div class="choice-grid" style="grid-template-columns: repeat(2, 1fr);">
                <button type="button" class="choice-button" data-value="–ù–æ–≤—ã–π">üöó –ù–æ–≤—ã–π (–∏–∑ –ö–∏—Ç–∞—è)</button>
                <button type="button" class="choice-button" data-value="–° –ø—Ä–æ–±–µ–≥–æ–º">‚öôÔ∏è –° –ø—Ä–æ–±–µ–≥–æ–º</button>
                <button type="button" class="choice-button" data-value="–ù–µ–≤–∞–∂–Ω–æ" style="grid-column: span 2;">ü§∑‚Äç‚ôÄÔ∏è –ù–µ–≤–∞–∂–Ω–æ</button>
            </div>
            <input type="hidden" name="–¢–∏–ø –∞–≤—Ç–æ" id="carType" required>
        </div>

        <div class="card form-step" data-step="2" style="display:none;">
            <h2>2/5. –£–∫–∞–∂–∏—Ç–µ –º–∞—Ä–∫—É –∏ –º–æ–¥–µ–ª—å –∞–≤—Ç–æ</h2>
            <p class="label">–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å</p>
            <input type="text" name="–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å" id="carModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Toyota Camry, BYD Song Plus" required>
        </div>

        <div class="card form-step" data-step="3" style="display:none;">
            <h2>3/5. –ñ–µ–ª–∞–µ–º—ã–π –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞</h2>
            <p class="label">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2020 ‚Äî 2024)</p>
            <input type="hidden" name="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞" id="carYear" required> 
            
            <div class="choice-grid" id="yearButtons">
                </div>
        </div>

        <div class="card form-step" data-step="4" style="display:none;">
            <h2>4/5. –ö–∞–∫ –í–∞—Å –∑–æ–≤—É—Ç?</h2>
            <p class="label">–í–∞—à–µ –ò–º—è</p>
            <input type="text" name="–ò–º—è" id="clientName" placeholder="–ò–≤–∞–Ω" required>
        </div>

        <div class="card form-step" data-step="5" style="display:none;">
            <h2>5/5. –í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h2>
            <p class="label">–¢–µ–ª–µ—Ñ–æ–Ω</p>
            <input type="tel" name="–¢–µ–ª–µ—Ñ–æ–Ω" id="clientPhone" placeholder="+7 (___) ___-__-__" required>
        </div>
    </form>
</div>

<script>
    // =======================================
    // JAVASCRIPT –õ–û–ì–ò–ö–ê –î–õ–Ø MINI APP
    // =======================================
    
    const Telegram = window.Telegram.WebApp;
    Telegram.ready();
    Telegram.expand(); 
    
    const formSteps = document.querySelectorAll('.form-step');
    const stepIndicator = document.getElementById('stepIndicator');
    const yearButtonsContainer = document.getElementById('yearButtons');
    let currentStep = 1;
    const totalSteps = formSteps.length;
    
    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –î–ò–ê–ü–ê–ó–û–ù–ê –ì–û–î–û–í ---
    let startYear = null;
    let endYear = null;

    // --- –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ì–û–î–û–í ---
    function generateYearButtons() {
        const currentYear = new Date().getFullYear();
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ–¥–æ–≤ —Å 2015 –ø–æ —Ç–µ–∫—É—â–∏–π + 1
        for (let year = currentYear + 1; year >= 2015; year--) {
            const button = document.createElement('button');
            button.type = 'button';
            button.classList.add('choice-button', 'year-range-button');
            button.dataset.value = year;
            button.textContent = year;
            yearButtonsContainer.appendChild(button);
        }
    }
    
    // ----------------------------------------
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–û–ô –ù–ê–ó–ê–î (Telegram BackButton)
    // ----------------------------------------
    if (Telegram.themeParams) {
        Telegram.MainButton.setParams({
            color: '#E74C3C', 
            text_color: '#FFFFFF'
        });
        
        Telegram.BackButton.show();
        Telegram.BackButton.onClick(() => {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            } else {
                Telegram.close();
            }
        });
    }

    // ----------------------------------------
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï UI
    // ----------------------------------------

    function updateMainButton(text, isVisible, isActive) {
        Telegram.MainButton.setParams({
            text: text,
            is_visible: isVisible,
            is_active: isActive
        });
    }

    function updateStepDots() {
        stepIndicator.innerHTML = '';
        for (let i = 1; i <= totalSteps; i++) {
            const dot = document.createElement('span');
            dot.classList.add('dot');
            if (i === currentStep) {
                dot.classList.add('active');
            }
            stepIndicator.appendChild(dot);
        }
    }
    
    // --- –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –ò –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò –í–´–ë–†–ê–ù–ù–û–ì–û –î–ò–ê–ü–ê–ó–û–ù–ê ---
    function visualizeYearRange() {
        const yearInput = document.getElementById('carYear');
        const buttons = document.querySelectorAll('.year-range-button');
        
        // 1. –°–±—Ä–æ—Å –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤
        buttons.forEach(btn => {
            btn.classList.remove('selected', 'in-range');
        });

        if (startYear && endYear) {
            const start = Math.min(startYear, endYear);
            const end = Math.max(startYear, endYear);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            yearInput.value = `${start}-${end}`;
            
            // 2. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
            buttons.forEach(btn => {
                const year = parseInt(btn.dataset.value);
                if (year >= start && year <= end) {
                    btn.classList.add('in-range');
                }
                if (year === start || year === end) {
                    btn.classList.add('selected'); 
                    btn.classList.remove('in-range'); 
                }
            });
            updateMainButton(Telegram.MainButton.text, true, true);
        } else if (startYear) {
            yearInput.value = startYear;
            document.querySelector(`.year-range-button[data-value="${startYear}"]`).classList.add('selected');
            updateMainButton(Telegram.MainButton.text, true, false); 
        } else {
            yearInput.value = '';
            updateMainButton(Telegram.MainButton.text, true, false); 
        }
    }


    function updateUI() {
        // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏
        updateStepDots();

        // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —à–∞–≥–∏
        formSteps.forEach(step => {
            const stepIndex = parseInt(step.dataset.step);
            step.style.display = (stepIndex === currentStep) ? 'block' : 'none';
        });
        
        // 3. –î–ª—è –®–∞–≥–∞ 3, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
        if (currentStep === 3) {
            visualizeYearRange();
        }
        
        // 4. –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram
        const isLastStep = currentStep === totalSteps;
        const buttonText = isLastStep ? '‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É' : '–î–ê–õ–ï–ï';
        updateMainButton(buttonText, true, checkStepValidity());
    }
    
    // ----------------------------------------
    // –ü–†–û–í–ï–†–ö–ê –í–ê–õ–ò–î–ù–û–°–¢–ò –¢–ï–ö–£–©–ï–ì–û –®–ê–ì–ê
    // ----------------------------------------

    function checkStepValidity() {
        switch (currentStep) {
            case 1: 
                return !!document.getElementById('carType').value;
            case 2: 
                return !!document.getElementById('carModel').value.trim();
            case 3: 
                // –í–∞–ª–∏–¥–Ω–æ, –µ—Å–ª–∏ –ø–æ–ª–µ carYear –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (—Ç.–µ. –±—ã–ª –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ–¥)
                return !!document.getElementById('carYear').value.trim();
            case 4: 
                return !!document.getElementById('clientName').value.trim();
            case 5: 
                const phoneValue = document.getElementById('clientPhone').value.trim();
                return phoneValue.length > 5;
            default:
                return false;
        }
    }
    
    // ----------------------------------------
    // –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö
    // ----------------------------------------

    // –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∞–≤—Ç–æ - –ò–°–ü–†–ê–í–õ–ï–ù–ê –õ–û–ì–ò–ö–ê –ê–ö–¢–ò–í–ê–¶–ò–ò –ö–ù–û–ü–ö–ò
    document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(button => {
        button.addEventListener('click', function() {
            // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('carType').value = this.dataset.value;
            
            // 2. –Ø–≤–Ω–æ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–î–ê–õ–ï–ï"
            const buttonText = currentStep === totalSteps ? '‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É' : '–î–ê–õ–ï–ï';
            updateMainButton(buttonText, true, checkStepValidity());
        });
    });

    // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –î–ò–ê–ü–ê–ó–û–ù–ê –ì–û–î–û–í (–®–ê–ì 3) ---
    function handleYearSelection(event) {
        const button = event.target.closest('.year-range-button');
        if (!button) return;
        
        const year = parseInt(button.dataset.value);

        if (startYear === null) {
            startYear = year;
            endYear = null;
        } else if (endYear === null) {
            endYear = year;
        } else {
            startYear = year;
            endYear = null;
        }
        
        visualizeYearRange();
    }
    
    yearButtonsContainer.addEventListener('click', handleYearSelection);


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
            if (currentStep !== 3) {
                updateMainButton(Telegram.MainButton.text, true, checkStepValidity());
            }
        });
    });
    
    // ----------------------------------------
    // –ù–ê–í–ò–ì–ê–¶–ò–Ø (MainButton)
    // ----------------------------------------

    Telegram.MainButton.onClick(() => {
        if (!checkStepValidity()) {
            Telegram.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –ø—É–Ω–∫—Ç.');
            return;
        }
        
        if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
            
            const nextStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
            const firstInput = nextStepElement ? nextStepElement.querySelector('input') : null;
            if (firstInput) {
                firstInput.focus();
            }
        } else {
            submitForm();
        }
    });
    
    // ----------------------------------------
    // –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´
    // ----------------------------------------

    function submitForm() {
        const formData = {};
        document.querySelectorAll('input').forEach(input => {
            if (input.name && input.value) {
                formData[input.name] = input.value;
            }
        });
        
        try {
            Telegram.sendData(JSON.stringify(formData));
            Telegram.MainButton.hide();
        } catch (error) {
            Telegram.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    generateYearButtons(); 
    updateUI(); 
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Бесплатный подбор авто</title>
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div class="header">
    <div class="logo-car"></div>
    <div class="logo-text">АВТОСЛОН</div>
</div>

<div class="container">
    
    <div class="step-indicator" id="stepIndicator">
        </div>
    
    <form id="carForm">
        <div class="card form-step" data-step="1">
            <h2>1/6. Какой автомобиль Вас интересует?</h2>
            <div class="choice-grid" style="grid-template-columns: repeat(1, 1fr);">
                <button type="button" class="choice-button" data-value="Новый">Только новые</button>
                <button type="button" class="choice-button" data-value="С пробегом">С пробегом</button>
                <button type="button" class="choice-button" data-value="Неважно">Неважно</button>
            </div>
            <input type="hidden" name="Тип авто" id="carType" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">НАЗАД</button>
                <button type="button" class="nav-button next" data-action="next">ДАЛЕЕ</button>
            </div>
        </div>

        <div class="card form-step" data-step="2" style="display:none;">
            <h2>2/6. Укажите марку и модель авто</h2>
            
            <p class="label">Марка/Модель</p>
            <input type="text" name="Марка/Модель" id="carModel" placeholder="Начните вводить название марки..." required>
            
            <div id="autocompleteResults" class="autocomplete-list">
                </div>
            
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">НАЗАД</button>
                <button type="button" class="nav-button next" data-action="next">ДАЛЕЕ</button>
            </div>
        </div>

        <div class="card form-step" data-step="3" style="display:none;">
            <h2>3/6. Желаемый год выпуска</h2>
            <p class="label">Выберите диапазон (например, 2020 — 2024)</p>
            <input type="hidden" name="Год выпуска" id="carYear" required> 
            
            <div class="choice-grid" id="yearButtons">
                </div>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">НАЗАД</button>
                <button type="button" class="nav-button next" data-action="next">ДАЛЕЕ</button>
            </div>
        </div>

        <div class="card form-step" data-step="4" style="display:none;">
            <h2>4/6. Как Вас зовут?</h2>
            <p class="label">Ваше Имя</p>
            <input type="text" name="Имя" id="clientName" placeholder="Иван" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">НАЗАД</button>
                <button type="button" class="nav-button next" data-action="next">ДАЛЕЕ</button>
            </div>
        </div>

        <div class="card form-step" data-step="5" style="display:none;">
            <h2>5/6. Ваш номер телефона</h2>
            <p class="label">Телефон</p>
            <input type="tel" name="Телефон" id="clientPhone" placeholder="+7 9ХХ ХХХ-ХХ-ХХ" required>
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">НАЗАД</button>
                <button type="button" class="nav-button next" data-action="next">ПРОВЕРИТЬ ДАННЫЕ</button>
            </div>
        </div>
        
        <div class="card form-step" data-step="6" style="display:none;">
            <h2>6/6. Проверьте данные</h2>
            <div id="reviewData">
                </div>
            
            <div class="nav-buttons">
                <button type="button" class="nav-button back" data-action="back">НАЗАД</button>
                <button type="button" class="nav-button next active" id="finalSubmitButton" data-action="submit">ОТПРАВИТЬ</button>
            </div>
        </div>
        
    </form>
</div>

<script>
    // =======================================
    // JAVASCRIPT ЛОГИКА ДЛЯ MINI APP
    // =======================================
    
    const Telegram = window.Telegram.WebApp;
    Telegram.ready();
    Telegram.expand(); 
    
    const formSteps = document.querySelectorAll('.form-step');
    const stepIndicator = document.getElementById('stepIndicator');
    const yearButtonsContainer = document.getElementById('yearButtons');
    const reviewDataContainer = document.getElementById('reviewData');
    const totalSteps = formSteps.length; 
    let currentStep = 1;

    let startYear = null;
    let endYear = null;

    // --- ЛОГИКА АВТОПОДСКАЗКИ (ШАГ 2) ---
    
    const CAR_BRANDS = [
        "Toyota", "Lexus", "Mercedes-Benz", "BMW", "Audi", "Hyundai", 
        "Kia", "Chevrolet", "Ford", "Honda", "Nissan", "Mazda", 
        "Volkswagen", "Geely", "Chery", "BYD", "Haval", "Exeed", 
        "LADA", "Porsche", "Land Rover", "Volvo"
    ];

    const carModelInput = document.getElementById('carModel');
    const autocompleteResults = document.getElementById('autocompleteResults');

    // ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ ПОДСКАЗОК
    function updateAutocomplete() {
        const inputVal = carModelInput.value.trim().toLowerCase();
        autocompleteResults.innerHTML = ''; 

        if (inputVal.length === 0) {
            autocompleteResults.style.display = 'none';
            return;
        }

        const filteredBrands = CAR_BRANDS.filter(brand => 
            brand.toLowerCase().startsWith(inputVal)
        ).slice(0, 5); 

        if (filteredBrands.length === 0) {
            autocompleteResults.style.display = 'none';
            return;
        }

        filteredBrands.forEach(brand => {
            const item = document.createElement('div');
            item.classList.add('autocomplete-item');
            
            const boldPart = brand.substring(0, inputVal.length);
            const restPart = brand.substring(inputVal.length);
            item.innerHTML = `<strong>${boldPart}</strong>${restPart}`;
            
            item.addEventListener('click', () => {
                carModelInput.value = brand + ' ';
                autocompleteResults.innerHTML = ''; 
                autocompleteResults.style.display = 'none';
                carModelInput.focus(); 
                updateUI(); 
            });
            
            autocompleteResults.appendChild(item);
        });

        autocompleteResults.style.display = 'block';
    }
    
    // --- ФУНКЦИЯ ГЕНЕРАЦИИ ГОДОВ ---
    function generateYearButtons() {
        const currentYear = new Date().getFullYear();
        for (let year = currentYear + 1; year >= 2015; year--) {
            const button = document.createElement('button');
            button.type = 'button';
            button.classList.add('choice-button', 'year-range-button');
            button.dataset.value = year;
            button.textContent = year;
            yearButtonsContainer.appendChild(button);
        }
    }
    
    // ----------------------------------------
    // УПРАВЛЕНИЕ КНОПКАМИ TELEGRAM (СКРЫВАЕМ)
    // ----------------------------------------
    if (Telegram.themeParams) {
        Telegram.MainButton.hide(); 
        Telegram.BackButton.hide();
        Telegram.BackButton.onClick(() => {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            } else {
                Telegram.close();
            }
        });
    }
    
    // ----------------------------------------
    // ОБРАБОТЧИК НАВИГАЦИИ (НАЗАД/ДАЛЕЕ/ОТПРАВИТЬ)
    // ----------------------------------------
    
    function handleNavigation(event) {
        const button = event.target.closest('.nav-button');
        if (!button) return;
        
        const action = button.dataset.action;

        if (action === 'back') {
            currentStep--;
            updateUI();
        } else if (action === 'next') {
            if (!button.classList.contains('active')) return;

            if (checkStepValidity()) {
                currentStep++;
                updateUI();
            } else {
                // Если кнопка неактивна, но пользователь нажимает на неё
                Telegram.showAlert('Пожалуйста, заполните или выберите нужный пункт.');
            }
        } else if (action === 'submit') {
            submitForm();
        }
    }

    document.getElementById('carForm').addEventListener('click', handleNavigation);
    
    // ----------------------------------------
    // ФУНКЦИИ ВОССТАНОВЛЕНИЯ СОСТОЯНИЯ
    // ----------------------------------------

    // ФИКС РЕДАКТИРОВАНИЯ ГОДОВ: Восстанавливает startYear и endYear из поля #carYear
    function loadYearRangeState() {
        const yearValue = document.getElementById('carYear').value.trim();
        startYear = null;
        endYear = null;

        if (yearValue) {
            if (yearValue.includes('-')) {
                const [start, end] = yearValue.split('-').map(Number);
                startYear = start;
                endYear = end;
            } else {
                startYear = Number(yearValue);
            }
        }
        // visualizeYearRange будет вызвана в updateUI
    }

    function createReviewField(label, value, step) {
        const div = document.createElement('div');
        div.classList.add('review-field');
        div.innerHTML = `
            <style>
                .review-field { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
                .review-field-label { color: var(--hint-color); font-size: 0.9em; }
                .review-field-value { color: var(--text-color); font-weight: 500; display: flex; align-items: center; gap: 8px; }
                .review-field-edit { 
                    background: none; border: none; color: var(--accent-light); 
                    font-size: 1.2em; cursor: pointer; padding: 0; margin: 0; 
                    transform: translateY(2px); 
                }
            </style>
            <span class="review-field-label">${label}</span>
            <span class="review-field-value">
                ${value}
                <button class="review-field-edit" data-step="${step}" onclick="editStep(${step})">✏️</button>
            </span>
        `;
        return div;
    }
    
    function populateReviewData() {
        reviewDataContainer.innerHTML = '';
        const formData = {};
        document.querySelectorAll('input').forEach(input => {
            if (input.name && input.value) {
                formData[input.name] = input.value;
            }
        });

        const labelMap = {
            'Тип авто': 'Тип', 
            'Марка/Модель': 'Марка и модель', 
            'Год выпуска': 'Год выпуска', 
            'Имя': 'Имя', 
            'Телефон': 'Телефон'
        };

        for (const key in formData) {
            const label = labelMap[key] || key;
            const value = formData[key];
            
            let stepForEdit = 0;
            if (key === 'Тип авто') stepForEdit = 1;
            else if (key === 'Марка/Модель') stepForEdit = 2;
            else if (key === 'Год выпуска') stepForEdit = 3;
            else if (key === 'Имя') stepForEdit = 4;
            else if (key === 'Телефон') stepForEdit = 5;

            if (stepForEdit > 0) {
                 reviewDataContainer.appendChild(createReviewField(label, value, stepForEdit));
            }
        }
    }
    
    window.editStep = function(step) {
        currentStep = step;
        updateUI();
    }
    
    // ----------------------------------------
    // УПРАВЛЕНИЕ UI
    // ----------------------------------------

    function updateStepDots() {
        stepIndicator.innerHTML = '';
        for (let i = 1; i <= totalSteps - 1; i++) { 
            const dot = document.createElement('span');
            dot.classList.add('dot');
            if (i === currentStep) {
                dot.classList.add('active');
            }
            stepIndicator.appendChild(dot);
        }
    }

    function updateUI() {
        updateStepDots();

        formSteps.forEach(step => {
            const stepIndex = parseInt(step.dataset.step);
            const isCurrent = (stepIndex === currentStep);
            step.style.display = isCurrent ? 'block' : 'none';

            if (isCurrent) {
                const nextButton = step.querySelector('.nav-button.next');
                const backButton = step.querySelector('.nav-button.back');
                
                if (backButton) {
                    backButton.style.display = (currentStep === 1) ? 'none' : 'block';
                }
                
                if (nextButton) {
                    if (checkStepValidity()) {
                        nextButton.classList.add('active');
                    } else {
                        nextButton.classList.remove('active');
                    }
                }
                
                // ВОССТАНОВЛЕНИЕ СОСТОЯНИЯ
                if (stepIndex === 1) {
                    const carType = document.getElementById('carType').value;
                    document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(btn => {
                        btn.classList.remove('selected');
                        if (btn.dataset.value === carType) {
                            btn.classList.add('selected');
                        }
                    });
                }
                
                if (stepIndex === 2) {
                    // Обязательно скрываем подсказку при показе шага, если нет ввода
                    updateAutocomplete();
                }
                
                if (stepIndex === 3) {
                    // ВОССТАНОВЛЕНИЕ ГОДОВ
                    loadYearRangeState();
                    visualizeYearRange();
                }
            }
        });
        
        if (currentStep === totalSteps) { // Шаг 6
            populateReviewData();
        }
        
        const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        const firstInput = currentStepElement ? currentStepElement.querySelector('input:not([type="hidden"])') : null;
        if (firstInput) {
            firstInput.focus();
        }
    }
    
    // ----------------------------------------
    // ПРОВЕРКА ВАЛИДНОСТИ ТЕКУЩЕГО ШАГА
    // ----------------------------------------

    function checkStepValidity() {
        switch (currentStep) {
            case 1: 
                return !!document.getElementById('carType').value;
            case 2: 
                return !!document.getElementById('carModel').value.trim();
            case 3: 
                return !!document.getElementById('carYear').value.trim();
            case 4: 
                return !!document.getElementById('clientName').value.trim();
            case 5: 
                const phoneValue = document.getElementById('clientPhone').value.trim();
                return phoneValue.length > 5;
            case 6: 
                return true; 
            default:
                return false;
        }
    }
    
    // --- ВИЗУАЛИЗАЦИЯ ДИАПАЗОНА ГОДОВ ---
    function visualizeYearRange() {
        const yearInput = document.getElementById('carYear');
        const buttons = document.querySelectorAll('.year-range-button');
        
        buttons.forEach(btn => {
            btn.classList.remove('selected', 'in-range');
        });

        if (startYear && endYear) {
            const start = Math.min(startYear, endYear);
            const end = Math.max(startYear, endYear);
            yearInput.value = `${start}-${end}`;
            
            buttons.forEach(btn => {
                const year = parseInt(btn.dataset.value);
                if (year >= start && year <= end) {
                    btn.classList.add('in-range');
                }
                if (year === start || year === end) {
                    btn.classList.add('selected'); 
                    btn.classList.remove('in-range'); 
                }
            });
            // Не вызываем updateUI(), так как визуализация уже завершена
        } else if (startYear) {
            yearInput.value = startYear;
            document.querySelector(`.year-range-button[data-value="${startYear}"]`)?.classList.add('selected');
            // Не вызываем updateUI()
        } else {
            yearInput.value = '';
            // Не вызываем updateUI()
        }
        // Обновляем состояние кнопки "ДАЛЕЕ" вручную после визуализации
        const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        const nextButton = currentStepElement ? currentStepElement.querySelector('.nav-button.next') : null;
        if (nextButton) {
             if (checkStepValidity()) {
                nextButton.classList.add('active');
            } else {
                nextButton.classList.remove('active');
            }
        }
    }
    
    // ----------------------------------------
    // ОБРАБОТКА ВЫБОРА (для Шагов 1 и 3)
    // ----------------------------------------

    // Шаг 1: Выбор типа авто
    document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.form-step[data-step="1"] .choice-button').forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('carType').value = this.dataset.value;
            updateUI(); 
        });
    });

    // --- ЛОГИКА ВЫБОРА ДИАПАЗОНА ГОДОВ (ШАГ 3) ---
    function handleYearSelection(event) {
        const button = event.target.closest('.year-range-button');
        if (!button) return;
        
        const year = parseInt(button.dataset.value);

        if (startYear === null) {
            startYear = year;
            endYear = null;
        } else if (endYear === null) {
            // Если выбранная дата меньше начальной, меняем их местами
            if (year < startYear) {
                endYear = startYear;
                startYear = year;
            } else {
                endYear = year;
            }
        } else {
            // Сбрасываем диапазон, начинаем новый
            startYear = year;
            endYear = null;
        }
        
        visualizeYearRange();
    }
    
    yearButtonsContainer.addEventListener('click', handleYearSelection);


    // Обработчики для полей ввода для динамической проверки
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => {
            // Обновляем UI для активации кнопки "ДАЛЕЕ"
            if (currentStep !== 3) {
                updateUI();
            }
        });
    });
    
    // Отдельный обработчик для автоподсказки
    carModelInput.addEventListener('input', () => {
        updateAutocomplete();
        updateUI(); 
    });
    
    // ----------------------------------------
    // ОТПРАВКА ФОРМЫ
    // ----------------------------------------

    function submitForm() {
        const finalButton = document.getElementById('finalSubmitButton');
        if (finalButton.textContent === 'ОТПРАВЛЕНО') return; 
        
        const formData = {};
        document.querySelectorAll('input').forEach(input => {
            if (input.name && input.value) {
                formData[input.name] = input.value;
            }
        });
        
        try {
            Telegram.sendData(JSON.stringify(formData));
            
            finalButton.textContent = 'ОТПРАВЛЕНО';
            finalButton.classList.remove('active');
            
            reviewDataContainer.innerHTML = '<h3>✅ Заявка успешно отправлена!</h3><p>Спасибо за ваш выбор. Скоро с вами свяжется менеджер.</p>';
            
        } catch (error) {
            Telegram.showAlert('Произошла ошибка при отправке данных: ' + error.message);
        }
    }

    // Инициализация
    generateYearButtons(); 
    updateUI(); 
</script>

</body>
</html>